<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heang.springmybatistest.auth.mapper.AuthUserMapper">

    <!-- ======================
         RESULT MAP
    ======================= -->
    <resultMap id="AppUserMap" type="com.heang.springmybatistest.auth.model.AppUser">
        <id property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="role" column="role"/>
        <result property="roleId" column="role_id"/>
        <result property="isVerified" column="is_verified"/>
        <result property="isActive" column="is_active"/>
    </resultMap>

    <!-- ======================
         INSERT USERS
    ======================= -->
    <select id="insertPartnerUser" parameterType="map" resultMap="AppUserMap">
        INSERT INTO tb_partner_account
        VALUES (DEFAULT, #{user.roleId}, #{user.email}, #{user.password},
        DEFAULT, DEFAULT, DEFAULT, DEFAULT)
        RETURNING *
    </select>

    <select id="insertMerchantUser" parameterType="map" resultMap="AppUserMap">
        INSERT INTO tb_merchant_account
        VALUES (DEFAULT, #{user.roleId}, #{user.email}, #{user.password},
        DEFAULT, DEFAULT, DEFAULT, DEFAULT)
        RETURNING *
    </select>

    <!-- ======================
         FIND USERS
    ======================= -->
    <select id="findPartnerUserByEmail" parameterType="string" resultMap="AppUserMap">
        SELECT
        ta.id,
        ta.email,
        ta.password,
        tr.name AS role,
        ta.role_id,
        ta.is_verified,
        ta.is_active
        FROM tb_partner_account ta
        JOIN tb_role tr ON ta.role_id = tr.id
        WHERE ta.email = #{email}
    </select>

    <select id="findPartnerUserById" parameterType="int" resultMap="AppUserMap">
        SELECT
        ta.id,
        ta.email,
        ta.password,
        tr.name AS role,
        ta.role_id,
        ta.is_verified,
        ta.is_active
        FROM tb_partner_account ta
        JOIN tb_role tr ON ta.role_id = tr.id
        WHERE ta.id = #{id}
    </select>

    <select id="findMerchantUserByEmail" parameterType="string" resultMap="AppUserMap">
        SELECT
        ta.id,
        ta.email,
        ta.password,
        tr.name AS role,
        ta.role_id,
        ta.is_verified,
        ta.is_active
        FROM tb_merchant_account ta
        JOIN tb_role tr ON ta.role_id = tr.id
        WHERE ta.email = #{email}
    </select>

    <!-- ======================
         PHONE CHECKS
    ======================= -->
    <select id="checkPhoneNumberFromPartnerPhone" parameterType="string" resultType="boolean">
        SELECT EXISTS(
        SELECT 1 FROM tb_partner_phone WHERE phone_number = #{phone}
        )
    </select>

    <select id="checkPhoneNumberFromPartnerDetail" parameterType="string" resultType="boolean">
        SELECT EXISTS(
        SELECT 1 FROM tb_partner_info WHERE primary_phone_number = #{phone}
        )
    </select>

    <select id="checkPhoneNumberFromMerchantPhone" parameterType="string" resultType="boolean">
        SELECT EXISTS(
        SELECT 1 FROM tb_merchant_phone WHERE phone_number = #{phone}
        )
    </select>

    <select id="checkPhoneNumberFromMerchantDetail" parameterType="string" resultType="boolean">
        SELECT EXISTS(
        SELECT 1 FROM tb_merchant_info WHERE primary_phone_number = #{phone}
        )
    </select>

    <!-- ======================
         ROLE ID
    ======================= -->
    <select id="getRoleIdByMailPartner" parameterType="string" resultType="int">
        SELECT role_id FROM tb_partner_account WHERE email = #{email}
    </select>

    <select id="getRoleIdByMailMerchant" parameterType="string" resultType="int">
        SELECT role_id FROM tb_merchant_account WHERE email = #{email}
    </select>

    <!-- ======================
         VERIFIED
    ======================= -->
    <select id="getVerifyPartnerEmail" parameterType="string" resultType="boolean">
        SELECT is_verified FROM tb_partner_account WHERE email = #{email}
    </select>

    <select id="getVerifyMerchantEmail" parameterType="string" resultType="boolean">
        SELECT is_verified FROM tb_merchant_account WHERE email = #{email}
    </select>

    <!-- ======================
         UPDATE PASSWORD (RETURNING *)
    ======================= -->
    <select id="updatePartnerUser" parameterType="map" resultMap="AppUserMap">
        UPDATE tb_partner_account
        SET password = #{req.newPassword}
        WHERE email = #{req.email}
        RETURNING *
    </select>

    <select id="updateMerchantUser" parameterType="map" resultMap="AppUserMap">
        UPDATE tb_merchant_account
        SET password = #{req.newPassword}
        WHERE email = #{req.email}
        RETURNING *
    </select>

    <!-- ======================
         FORGET PASSWORD
    ======================= -->
    <select id="updateForgetPartnerUser" parameterType="map" resultType="string">
        UPDATE tb_partner_account
        SET password = #{newPassword}
        WHERE email = #{email}
        RETURNING password
    </select>

    <select id="updateForgetMerchantUser" parameterType="map" resultType="string">
        UPDATE tb_merchant_account
        SET password = #{newPassword}
        WHERE email = #{email}
        RETURNING password
    </select>

    <!-- ======================
         GET USER ID
    ======================= -->
    <select id="getUserIdByMailPartner" parameterType="string" resultType="int">
        SELECT id FROM tb_partner_account WHERE email = #{email}
    </select>

    <select id="getUserIdByMailMerchant" parameterType="string" resultType="int">
        SELECT id FROM tb_merchant_account WHERE email = #{email}
    </select>

</mapper>
