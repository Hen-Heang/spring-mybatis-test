<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heang.springmybatistest.mapper.UserMapper">

    <!-- ===================================
         Common Result Map (공통 결과 매핑)
         =================================== -->
    <resultMap id="UserMap" type="com.heang.springmybatistest.model.Users">
        <id     property="id"        column="id"/>
        <result property="username"  column="username"/>
        <result property="email"     column="email"/>
        <result property="password"  column="password"/>
        <result property="name"      column="name"/>
        <result property="phone"     column="phone"/>
        <result property="role"      column="role"/>
        <result property="status"    column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>

    </resultMap>

    <sql id="UserColumns">
        id, username, email, password, name, phone, role, status, created_at, updated_at
    </sql>

    <!-- ===================================
         기존 CRUD 쿼리
         =================================== -->

    <!-- INSERT (기존) -->
    <insert id="insertUser"
            parameterType="com.heang.springmybatistest.dto.UserRequest">
        INSERT INTO users (
            username,
            email,
            name,
            phone,
            password,
            role,
            status
        ) VALUES (
            #{username},
            #{email},
            #{name},
            #{phone},
            #{password},
            COALESCE(#{role}, 'ROLE_USER'),
            COALESCE(#{status}, 'ACTIVE')
        )
    </insert>

    <!-- SELECT ALL -->
    <select id="selectUserList" resultMap="UserMap">
        SELECT
            <include refid="UserColumns"/>
        FROM users
        ORDER BY id DESC
    </select>

    <!-- SELECT BY ID -->
    <select id="selectUserById" parameterType="long" resultMap="UserMap">
        SELECT
            <include refid="UserColumns"/>
        FROM users
        WHERE id = #{id}
    </select>

    <!-- SEARCH + PAGINATION -->
    <select id="searchUsers" parameterType="com.heang.springmybatistest.dto.UserSearchRequest" resultMap="UserMap">
        SELECT
            <include refid="UserColumns"/>
        FROM users
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="email != null and email != ''">
                AND email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (username LIKE CONCAT('%', #{keyword}, '%')
                OR email LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="ids != null and ids.size() > 0">
                AND id IN
                <foreach collection="ids" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND status IN
                <foreach collection="statuses" item="st" open="(" close=")" separator=",">
                    #{st}
                </foreach>
            </if>
            <if test="startDate != null">
                AND created_at &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND created_at &lt;= #{endDate}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sortBy == 'username'">username</when>
            <when test="sortBy == 'email'">email</when>
            <when test="sortBy == 'createdAt'">created_at</when>
            <when test="sortBy == 'status'">status</when>
            <otherwise>id</otherwise>
        </choose>
        <choose>
            <when test="sortOrder == 'ASC'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        <if test="size != null and offset != null">
            LIMIT #{size} OFFSET #{offset}
        </if>
    </select>

    <select id="countUsers" parameterType="com.heang.springmybatistest.dto.UserSearchRequest" resultType="int">
        SELECT COUNT(*)
        FROM users
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="email != null and email != ''">
                AND email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (username LIKE CONCAT('%', #{keyword}, '%')
                OR email LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="ids != null and ids.size() > 0">
                AND id IN
                <foreach collection="ids" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND status IN
                <foreach collection="statuses" item="st" open="(" close=")" separator=",">
                    #{st}
                </foreach>
            </if>
            <if test="startDate != null">
                AND created_at &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND created_at &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- UPDATE -->
    <update id="updateUser">
        UPDATE users
        SET
            username = #{req.username},
            email    = #{req.email},
            status   = COALESCE(#{req.status}, status),
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- DELETE -->
    <delete id="deleteUser" parameterType="long">
        DELETE FROM users
        WHERE id = #{id}
    </delete>

    <!-- ===================================
         Spring Security 관련 쿼리
         =================================== -->

    <!-- 사용자명으로 조회 (로그인용) -->
    <select id="selectUserByUsername" parameterType="string" resultMap="UserMap">
        SELECT
            id, username, email, password, name, phone, role, status, created_at, updated_at
        FROM users
        WHERE username = #{username}
    </select>

    <!-- 이메일로 조회 -->
    <select id="selectUserByEmail" parameterType="string" resultMap="UserMap">
        SELECT
            id, username, email, password, name, phone, role, status, created_at, updated_at
        FROM users
        WHERE email = #{email}
    </select>

    <!-- 사용자명 중복 확인 -->
    <select id="countByUsername" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM users WHERE username = #{username}
    </select>

    <!-- 이메일 중복 확인 -->
    <select id="countByEmail" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM users WHERE email = #{email}
    </select>

    <!-- 회원가입 (비밀번호 포함) -->
    <insert id="insertUserWithPassword" parameterType="com.heang.springmybatistest.model.Users"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (
            username, email, password, name, phone, role, status
        ) VALUES (
            #{username},
            #{email},
            #{password},
            #{name},
            #{phone},
            COALESCE(#{role}, 'ROLE_USER'),
            COALESCE(#{status}, 'ACTIVE')
        )
    </insert>

    <!-- 비밀번호 변경 -->
    <update id="updatePassword">
        UPDATE users
        SET password = #{password}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 마지막 로그인 시간 업데이트 -->
    <update id="updateLastLogin" parameterType="long">
        UPDATE users
        SET updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

</mapper>
